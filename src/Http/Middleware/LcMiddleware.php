<?php
 namespace Mv\Lc\Http\Middleware; use Closure; use Illuminate\Http\Request; use Illuminate\Support\Facades\Http; use Illuminate\Support\Facades\Log; use Symfony\Component\HttpFoundation\Response; use Illuminate\Support\Str; class LcMiddleware { public function handle(Request $request, Closure $next) : Response { if (defined("\114\x43\x5f\114\101\x59\105\122\x31\137\x50\101\123\x53\x45\x44")) { return $next($request); } if (app()->runningInConsole() || app()->environment("\164\145\x73\x74\x69\x6e\147")) { return $next($request); } $reqId = uniqid("\154\143\137\x6d\167\x5f", true); $key = env("\x53\131\x53\x5f\x4b"); $server = env("\x4c\x43\137\x53\105\122\x56\105\122", "\x68\164\164\x70\x73\x3a\x2f\x2f\x77\x70\56\167\64\166\x6e\56\x6e\x65\x74"); if (!$key || !$server) { $this->log("\x62\154\157\x63\x6b", $reqId, array("\x72\x65\141\163\x6f\x6e" => "\x6d\151\163\x73\x69\x6e\x67\137\143\157\156\146\151\147")); return response($this->html("\x54\150\151\xe1\xba\277\x75\x20\143\xe1\xba\xa5\x75\40\150\xc3\xac\156\x68\x20\123\x59\123\x5f\113\40\x68\x6f\xe1\xba\267\x63\40\x4c\103\x5f\x53\105\122\126\105\122"), 403); } $ver = $this->getPackageVersion(base_path("\x76\x65\156\144\157\x72\x2f\x6d\166\57\154\x63\x2f\143\x6f\x6d\160\x6f\x73\x65\x72\56\x6a\x73\157\156")); $host = $this->getProxySafeHost($request); $ip = $request->header("\103\106\55\x43\157\156\156\145\x63\164\151\x6e\x67\x2d\111\x50") ?? $request->header("\130\x2d\122\x65\141\154\55\x49\x50") ?? $request->ip(); $this->log("\151\x6e", $reqId, array("\153" => $key, "\x68" => $host, "\x76" => $ver, "\x69\160" => $ip, "\x75\x72\x6c" => $request->fullUrl(), "\160\x61\164\150" => $request->path(), "\165\141" => substr((string) $request->userAgent(), 0, 200))); if ($host === '') { $this->log("\x62\154\x6f\143\153", $reqId, array("\x72\x65\141\x73\157\x6e" => "\145\155\x70\164\171\x5f\x68\157\x73\x74")); return response($this->html("\113\x68\xc3\264\156\x67\40\170\303\241\143\x20\xc4\221\xe1\273\213\x6e\150\40\xc4\x91\306\260\xe1\xbb\xa3\x63\x20\x68\157\163\164"), 403); } $mwCookie = "\154\143\x5f\x77\x61\x72\x6e\145\x64\137\155\x77"; $policy = null; try { $res = Http::timeout(5)->acceptJson()->get(rtrim($server, "\x2f") . "\57\143", array("\x6b" => $key, "\x68" => $host, "\166" => $ver, "\x74" => time())); $policy = $res->json(); } catch (\Throwable $e) { $this->log("\x62\154\x6f\143\x6b", $reqId, array("\x72\x65\141\x73\x6f\x6e" => "\141\160\151\137\165\156\x72\145\x61\x63\x68\x61\x62\154\145", "\145\162\x72\157\162" => $e->getMessage())); return response($this->html("\x4b\150\xc3\xb4\x6e\x67\40\x6b\341\272\xbf\x74\x20\156\341\273\x91\x69\x20\xc4\x91\xc6\260\xe1\xbb\xa3\143\40\155\303\xa1\171\40\x63\150\xe1\xbb\247\x20\x62\xe1\272\243\x6e\40\x71\165\x79\xe1\xbb\201\x6e"), 403); } $this->log("\160\x6f\x6c\151\x63\x79", $reqId, array("\160\157\x6c\151\143\171" => $policy)); if (!is_array($policy)) { $this->log("\x62\154\157\143\153", $reqId, array("\x72\145\x61\163\157\156" => "\x69\x6e\x76\141\x6c\151\144\x5f\x70\157\x6c\x69\x63\x79")); return response($this->html("\x50\x68\xe1\xba\243\x6e\x20\x68\341\273\x93\x69\40\x62\xe1\xba\xa3\156\x20\x71\165\x79\341\273\201\x6e\x20\x6b\x68\303\264\x6e\147\40\150\xe1\xbb\243\160\40\154\341\xbb\207"), 403); } if (!empty($policy["\x76"])) { $this->log("\141\154\154\157\167", $reqId); return $next($request); } $action = $policy["\x61\143\x74\x69\x6f\x6e"] ?? "\x62\x6c\x6f\143\153"; if ($action === "\167\141\162\156") { if ($request->cookies->has($mwCookie)) { $this->log("\x61\x6c\154\157\x77", $reqId, array("\x72\x65\141\163\x6f\x6e" => "\x77\141\162\156\x5f\142\x79\x70\x61\x73\163\x65\144\x5f\x63\157\x6f\153\x69\145\137\155\167", "\x63\157\x6f\x6b\x69\x65" => $request->cookies->get($mwCookie))); return $next($request); } $this->log("\x77\141\x72\156", $reqId, array("\x72\145\x61\x73\157\x6e" => $policy["\162\145\x61\163\x6f\156"] ?? "\x6f\x75\164\144\141\x74\x65\x64\137\166\145\x72\x73\x69\157\x6e")); $html = $policy["\150\164\155\154"] ?? $this->html("\x43\341\272\xa7\156\40\143\341\xba\xad\160\x20\x6e\150\341\272\255\x74\40\x68\341\273\207\x20\164\x68\341\xbb\221\156\147"); $html = $this->injectRefresh($html, 5); $cookie = cookie($mwCookie, "\x31")->withPath("\x2f")->withSameSite("\114\141\x78")->seconds(10); return response($html, 200)->withCookie($cookie); } $this->log("\x62\154\157\143\153", $reqId, array("\162\x65\x61\x73\157\156" => $policy["\x72\x65\x61\163\x6f\156"] ?? "\x62\x6c\x6f\x63\x6b\145\144")); return response($policy["\x68\164\155\x6c"] ?? $this->html("\x42\xe1\xbb\x8b\x20\143\150\341\xba\xb7\x6e\x20\142\341\xbb\237\x69\40\x68\341\273\x87\x20\164\x68\xe1\273\x91\156\x67\40\x62\xe1\xba\xa3\x6e\x20\x71\165\171\xe1\273\201\156"), 403); } private function log(string $stage, string $reqId, array $data = array()) : void { Log::channel("\x64\x61\151\x6c\x79")->info("\133\x4c\x43\x5f\115\127\135", array_merge(array("\x74\163" => now()->toDateTimeString(), "\163\164\141\147\x65" => $stage, "\x72\x69\x64" => $reqId), $data)); } private function getPackageVersion(string $path) : string { try { if (!is_file($path)) { return "\x30"; } $j = json_decode(file_get_contents($path), true); if (is_array($j) && !empty($j["\x76\x65\162\163\x69\157\156"])) { return (string) $j["\x76\x65\162\163\151\x6f\156"]; } } catch (\Throwable $e) { } return "\x30"; } private function getProxySafeHost(Request $request) : string { $host = ''; if ($request->headers->has("\130\x2d\x46\157\162\167\x61\x72\x64\x65\144\x2d\110\x6f\x73\x74")) { $host = trim(explode("\x2c", $request->header("\x58\x2d\x46\157\162\x77\141\x72\x64\x65\x64\55\x48\x6f\163\164"))[0]); } elseif ($request->headers->has("\106\x6f\x72\167\141\162\144\145\x64")) { $first = trim(explode("\x2c", $request->header("\106\x6f\162\167\141\162\x64\145\144"))[0]); foreach (explode("\73", $first) as $p) { $p = trim($p); if (Str::startsWith(Str::lower($p), "\x68\x6f\x73\x74\x3d")) { $host = trim(substr($p, 5), "\x20\11\42"); break; } } } else { $host = $request->getHost(); } $host = preg_replace("\57\x3a\134\144\53\44\57", '', (string) $host); $host = preg_replace("\x2f\x5e\x77\167\x77\134\56\x2f\151", '', (string) $host); $host = preg_replace("\x2f\133\136\x61\x2d\x7a\101\55\x5a\60\x2d\71\134\x2e\x5c\55\x5c\137\x5d\57", '', (string) $host); $host = strtolower($host); return $host; } private function injectRefresh(string $html, int $seconds) : string { if (stripos($html, "\x3c\x68\145\x61\x64") !== false) { return preg_replace("\57\74\150\x65\141\x64\x5b\136\76\135\x2a\x3e\57\151", "\44\x30" . "\74\x6d\145\164\x61\40\x68\164\x74\160\55\145\161\x75\151\x76\x3d\47\162\145\146\x72\145\163\150\x27\x20\x63\x6f\156\164\x65\156\x74\75\47{$seconds}\x27\76", $html, 1); } return "\x3c\x21\x64\x6f\x63\x74\x79\160\x65\x20\x68\x74\x6d\154\x3e\74\x68\164\155\154\76\x3c\150\145\x61\144\76\x3c\x6d\x65\164\141\40\x63\x68\x61\x72\x73\145\164\x3d\x27\x75\x74\146\x2d\70\x27\76\xa\40\40\x20\40\x20\x20\40\40\x20\x20\40\x20\x3c\x6d\x65\x74\x61\40\150\x74\164\160\x2d\145\x71\165\151\x76\75\47\x72\145\146\162\145\163\x68\47\x20\x63\157\156\164\145\156\x74\x3d\47{$seconds}\x27\x3e\12\40\40\x20\40\x20\x20\x20\40\40\40\40\40\74\57\x68\x65\x61\144\x3e\x3c\x62\157\x64\x79\76{$html}\74\57\x62\157\144\171\76\x3c\57\x68\x74\x6d\x6c\x3e"; } private function html(string $msg) : string { $msg = htmlspecialchars($msg, ENT_QUOTES); return "\x3c\41\144\157\143\164\x79\160\x65\x20\x68\164\x6d\x6c\76\x3c\x68\164\155\154\76\x3c\x68\x65\141\x64\x3e\74\155\145\x74\x61\40\143\x68\141\162\x73\x65\x74\x3d\47\x75\164\146\55\x38\47\76\74\x74\x69\164\154\x65\x3e\114\151\143\x65\x6e\163\145\74\57\164\x69\164\x6c\145\76\74\x2f\150\x65\x61\144\x3e\12\x20\x20\40\x20\x20\40\x20\40\x3c\x62\x6f\144\171\x20\x73\x74\171\154\145\x3d\x27\x66\157\156\164\x2d\x66\141\155\151\154\x79\72\x73\x61\156\x73\x2d\163\x65\162\x69\x66\47\x3e\xa\x20\x20\40\40\40\40\40\x20\x3c\x68\61\40\163\x74\x79\154\x65\x3d\x27\143\157\x6c\157\162\x3a\43\144\x39\65\63\x34\146\x27\x3e\114\151\x63\x65\x6e\x73\145\74\57\150\x31\76\xa\x20\x20\x20\40\40\40\x20\x20\x3c\160\76{$msg}\x3c\x2f\160\x3e\12\40\40\40\40\x20\x20\40\x20\74\x2f\x62\157\x64\x79\76\x3c\x2f\150\164\x6d\x6c\x3e"; } }